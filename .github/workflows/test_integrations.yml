name: Integration Tests

on:
  # Auto run for maintainer PRs
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

  # Auto run when code lands on main
  push:
    branches: [main]

  # Manual for forks (maintainer provides PR number)
  workflow_dispatch:
    inputs:
      pr:
        description: "PR number (MUST REVIEW CODE FIRST)"
        required: true
      ref_kind:
        description: "Which ref to test (merge|head)"
        required: false
        default: "merge"

permissions:
  contents: read
  checks: write
  pull-requests: read

concurrency:
  group: ${{ github.event_name == 'pull_request'
    && format('full-tests-pr-{0}-merge', github.event.pull_request.number)
    || github.event_name == 'workflow_dispatch'
    && format('full-tests-pr-{0}-{1}', github.event.inputs.pr, github.event.inputs.ref_kind)
    || format('full-tests-push-{0}', github.ref_name) }}
  cancel-in-progress: true

jobs:
  test:
    # Run if:
    # - workflow_dispatch (manual)
    # - OR IF pull_request where PR head repo == this repo and owner is confident-ai
    # - OR IF push to main on confident-ai/*
    if: ${{ github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      startsWith(github.repository, 'confident-ai/') &&
      !github.event.pull_request.draft) ||
      (github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      startsWith(github.repository, 'confident-ai/')) }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: ci-secrets
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CONFIDENT_API_KEY: ${{ secrets.CONFIDENT_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      DEEPEVAL_TELEMETRY_OPT_OUT: "1"
      DEEPEVAL_LOG_STACK_TRACES: "1"
      DEEPEVAL_RETRY_MAX_ATTEMPTS: "1"
      DEEPEVAL_PER_ATTEMPT_TIMEOUT_SECONDS_OVERRIDE: "120"
      LOG_LEVEL: "info"
      PYTHONFAULTHANDLER: "1"
      PYTHONASYNCIODEBUG: "1"
      PYTHONUNBUFFERED: "1"
      PYTEST_ADDOPTS: >-
        -vv -rfE --maxfail=1 --capture=tee-sys
        --durations=5
        -o log_cli=true -o log_cli_level=INFO --log-disable=httpcore --log-disable=httpx --log-disable=openai
        --log-cli-format="%(asctime)s %(levelname)s [%(name)s] %(message)s"
    
    steps:
      - name: Resolve target SHA (PR head/merge or push SHA)
        id: refsel
        env:
          GH_TOKEN: ${{ github.token }}        
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For maintainer PRs, GitHub provides the head SHA directly.
            echo "sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "pr=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "kind=head" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Resolve via API so we *always* test the intended PR code, regardless of which branch
          # the workflow file was dispatched from.
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            pr="${{ github.event.inputs.pr }}"
            kind="${{ github.event.inputs.ref_kind }}"

            if [ "$kind" = "head" ]; then
              sha="$(gh api repos/${{ github.repository }}/pulls/"$pr" --jq '.head.sha')"
              echo "sha=$sha" >> "$GITHUB_OUTPUT"
              echo "pr=$pr" >> "$GITHUB_OUTPUT"
              echo "kind=head" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # merge kind: prefer merge_commit_sha, but it can be null if GitHub can't create it.
            merge_sha="$(gh api repos/${{ github.repository }}/pulls/"$pr" --jq '.merge_commit_sha // empty')"
            if [ -n "${merge_sha:-}" ]; then
              echo "sha=$merge_sha" >> "$GITHUB_OUTPUT"
              echo "pr=$pr" >> "$GITHUB_OUTPUT"
              echo "kind=merge" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            
            # Fallback to head SHA if merge SHA isn't available.
            head_sha="$(gh api repos/${{ github.repository }}/pulls/"$pr" --jq '.head.sha')"
            echo "sha=$head_sha" >> "$GITHUB_OUTPUT"
            echo "pr=$pr" >> "$GITHUB_OUTPUT"
            echo "kind=head-fallback" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # push (main): test exactly the pushed commit
          echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          echo "pr=" >> "$GITHUB_OUTPUT"
          echo "kind=push" >> "$GITHUB_OUTPUT"

      - name: Checkout resolved SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.refsel.outputs.sha }}
          fetch-depth: 0

      - name: Log target
        run: |
          echo "Event: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR: #${{ github.event.pull_request.number }} (checked out head SHA)"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual PR: #${{ steps.refsel.outputs.pr }} (kind=${{ steps.refsel.outputs.kind }})"
          else
            echo "Push target: ${GITHUB_REF_NAME} @ ${GITHUB_SHA}"
          fi
          echo "Checked out SHA: $(git rev-parse HEAD)"

      # Manual run: create a Check Run against the exact checked-out commit
      - name: Set up python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-integrations-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies (no cache)
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root --only main

      - name: Install project
        run: poetry install --no-interaction --only main

      - name: Install integration extras
        run: poetry install --with integrations

      - name: Run integration tests (with secrets)
        if: ${{ env.OPENAI_API_KEY != '' && env.CONFIDENT_API_KEY != '' && env.ANTHROPIC_API_KEY != '' }}
        run: >
          poetry run pytest -vv -rA --maxfail=1 --capture=tee-sys
          --ignore=tests/test_integrations/test_crewai/
          --ignore=tests/test_integrations/test_langchain/
          --ignore=tests/test_integrations/test_langgraph/
          tests/test_integrations/

      - name: Run integration tests (no secrets)
        if: ${{ env.OPENAI_API_KEY == '' || env.CONFIDENT_API_KEY == '' || env.ANTHROPIC_API_KEY == '' }}
        run: echo "Skipping integration tests - API keys required."

  langchain:
    # Run conditions (same as test job)
    if: ${{ github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      startsWith(github.repository, 'confident-ai/') &&
      !github.event.pull_request.draft) ||
      (github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      startsWith(github.repository, 'confident-ai/')) }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: ci-secrets
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CONFIDENT_API_KEY: ${{ secrets.CONFIDENT_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      DEEPEVAL_TELEMETRY_OPT_OUT: "1"
      DEEPEVAL_LOG_STACK_TRACES: "1"
      DEEPEVAL_RETRY_MAX_ATTEMPTS: "1"
      DEEPEVAL_PER_ATTEMPT_TIMEOUT_SECONDS_OVERRIDE: "120"
      LOG_LEVEL: "info"
      PYTHONFAULTHANDLER: "1"
      PYTHONASYNCIODEBUG: "1"
      PYTHONUNBUFFERED: "1"
      PYTEST_ADDOPTS: >-
        -vv -rfE --maxfail=1 --capture=tee-sys
        --durations=5
        -o log_cli=true -o log_cli_level=INFO --log-disable=httpcore --log-disable=httpx --log-disable=openai
        --log-cli-format="%(asctime)s %(levelname)s [%(name)s] %(message)s"

    steps:
      - name: Resolve target SHA
        id: refsel
        env:
          GH_TOKEN: ${{ github.token }}        
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # (Simplified for brevity, matches the logic in 'test' job)
          echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Checkout resolved SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.refsel.outputs.sha }}
          fetch-depth: 0

      - name: Set up python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-langchain-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies (no cache)
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root --only main

      - name: Install project
        run: poetry install --no-interaction --only main

      - name: Install langchain extras
        run: poetry install --with langchain

      - name: Run langchain/langgraph tests (with secrets)
        if: ${{ env.OPENAI_API_KEY != '' && env.CONFIDENT_API_KEY != '' && env.ANTHROPIC_API_KEY != '' }}
        run: >
          poetry run pytest -vv -rA --maxfail=1 --capture=tee-sys
          tests/test_integrations/test_langchain/
          tests/test_integrations/test_langgraph/
          

      - name: Run langchain/langgraph tests (no secrets)
        if: ${{ env.OPENAI_API_KEY == '' || env.CONFIDENT_API_KEY == '' || env.ANTHROPIC_API_KEY == '' }}
        run: echo "Skipping langchain tests - API keys required."

  crewai:
    if: ${{ github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      startsWith(github.repository, 'confident-ai/') &&
      !github.event.pull_request.draft) ||
      (github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      startsWith(github.repository, 'confident-ai/')) }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: ci-secrets
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CONFIDENT_API_KEY: ${{ secrets.CONFIDENT_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      DEEPEVAL_TELEMETRY_OPT_OUT: "1"
      DEEPEVAL_LOG_STACK_TRACES: "1"
      DEEPEVAL_RETRY_MAX_ATTEMPTS: "1"
      DEEPEVAL_PER_ATTEMPT_TIMEOUT_SECONDS_OVERRIDE: "120"
      LOG_LEVEL: "info"
      PYTHONFAULTHANDLER: "1"
      PYTHONASYNCIODEBUG: "1"
      PYTHONUNBUFFERED: "1"
      PYTEST_ADDOPTS: >-
        -vv -rfE --maxfail=1 --capture=tee-sys
        --durations=5
        -o log_cli=true -o log_cli_level=INFO --log-disable=httpcore --log-disable=httpx --log-disable=openai
        --log-cli-format="%(asctime)s %(levelname)s [%(name)s] %(message)s"

    steps:
      - name: Resolve target SHA
        id: refsel
        env:
          GH_TOKEN: ${{ github.token }}        
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # (Simplified for brevity, matches the logic in 'test' job)
          echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Checkout resolved SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.refsel.outputs.sha }}
          fetch-depth: 0

      - name: Set up python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-crewai-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies (CrewAI Special Setup)
        run: |
          poetry install --no-interaction --no-root --only main
          poetry run pip install -U crewai
          poetry run pip install -U pydantic-ai sdk

      - name: Install project
        run: poetry install --no-interaction --only main

      - name: Run CrewAI Tests
        if: ${{ env.OPENAI_API_KEY != '' }}
        run: |
          poetry run pytest tests/test_integrations/test_crewai/test_sync.py
          poetry run pytest tests/test_integrations/test_crewai/test_async.py
          poetry run pytest tests/test_integrations/test_crewai/test_knowledge_retriever.py
          poetry run pytest tests/test_integrations/test_crewai/test_crewai_component.py
          poetry run pytest tests/test_integrations/test_crewai/test_crewai.py
          poetry run pytest tests/test_integrations/test_crewai/test_stress.py

      - name: Run CrewAI Tests (no secrets)
        if: ${{ env.OPENAI_API_KEY == '' }}
        run: echo "Skipping CrewAI tests - API keys required."
